'''
Created on July 17th, 2013

__author__ = "Elizabeth 'pidge' Flanagan"
__copyright__ = "Copyright 2013, Intel Corp."
__credits__ = ["Elizabeth Flanagan"]
__license__ = "GPL"
__version__ = "2.0"
__maintainer__ = "Elizabeth Flanagan"
__email__ = "pidge@toganlabs.com"
'''
from buildbot.steps.shell import ShellCommand
from buildbot.status import progress
from buildbot.status.results import SUCCESS, FAILURE, WARNINGS
from buildbot.process.properties import WithProperties
from twisted.python import log
from autobuilder.config import *

class GetLayerVersion(ShellCommand):
    haltOnFailure = False
    flunkOnFailure = False
    name = "GetLayerVersion"
    def __init__(self, factory, layerversion=None, workdir='build', argdict=None, **kwargs):
        for k, v in argdict.iteritems():
            setattr(self, k, v)
        self.description = "Get Layer Version"
        self.layerversion = layerversion
        self.layerfile = layerversion
        self.workdir=workdir
        self.workerworkdir=os.path.join(os.path.join(YOCTO_ABBASE, "yocto-worker"))
        for k, v in argdict.iteritems():
            setattr(self, k, v)
        ShellCommand.__init__(self, **kwargs)

    def start(self):
        buildername=self.getProperty("buildername")
        log.msg(self.workdir)
        log.msg(self.layerversion)
        if self.layerversion == "poky":
            self.layerfile = "yocto"
        layerconf=self.workerworkdir + "/" + buildername + "/build/" + self.workdir + "/conf/layer.conf|grep LAYERVERSION_" + self.layerfile
        cmd = 'cat ' + layerconf
        self.command = cmd
        ShellCommand.start(self)

    def commandComplete(self, cmd):
        if not cmd.didFail():
            result = cmd.logs['stdio'].getText()
            layerv = result.replace("LAYERVERSION_" + self.layerfile, "").replace("=","").replace(' ','').replace('"','').replace("'",'').strip()
            if not self.getProperty('layerversion_' + self.layerfile):
                self.setProperty('layerversion_' + self.layerfile, layerv, "Setting Layer Version")
        self.finished(SUCCESS)

    def getText(self, cmd, results):
        return ShellCommand.getText(self, cmd, results)
